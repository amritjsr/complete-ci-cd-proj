pipeline {
    agent any

    stages {

        stage('Checkout Code') {
            steps {
                withCredentials([string(credentialsId: 'github_token', variable: 'GHTOKEN')]) {
                    sh '''
                      rm -rf complete-ci-cd-proj
                      git clone https://$GHTOKEN@github.com/amritjsr/complete-ci-cd-proj.git
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                sh '''
                  cd complete-ci-cd-proj

                  echo "Building FRONTEND image..."
                  cd emp_mgmt_frontend
                  docker build -t emp_mgmt_frontend:latest .
                  cd ..

                  echo "Building BACKEND image..."
                  cd emp_mgmt_backend
                  docker build -t emp_mgmt_backend:latest .
                '''
            }
        }

        stage('Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_hub_token',
                                                 usernameVariable: 'DH_USER',
                                                 passwordVariable: 'DH_TOKEN')]) {

                    sh '''
                      echo "Logging in to Docker Hub..."
                      echo "$DH_TOKEN" | docker login -u "$DH_USER" --password-stdin

                      echo "Tagging images..."
                      docker tag emp_mgmt_frontend:latest $DH_USER/emp_mgmt_frontend:latest
                      docker tag emp_mgmt_backend:latest  $DH_USER/emp_mgmt_backend:latest

                      echo "Pushing images..."
                      docker push $DH_USER/emp_mgmt_frontend:latest
                      docker push $DH_USER/emp_mgmt_backend:latest

                      docker logout
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                sh 'echo Running tests...'
            }
        }

        stage('Deploy') {
            steps {
                sh 'echo Deploying...'
            }
        }
    }
}
